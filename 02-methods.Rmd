# Methods 

```{r setup}
library(tidyverse)
library(lubridate)
```


In 2018, the Utah Transit Authority (UTA) launched a Bus Rapid Transit (BRT)
system in Provo, Utah, United States. Known as the Utah Valley eXpress (UVX), 
the system was highly successful prior to the onset of the COVID-19 pandemic 
with more than 10,000 riders per average weekday [cite].  The system connects
two commuter rail stations, two major universities (Brigham Young and Utah Valley),
and commercial retail districts in Orem and Provo. The system includes X miles of
dedicated lanes on its X-mile route, and 18 stations with a mix of center and side
boarding, all at level floors. The system has been free for all riders since its
opening.

```{r load_data}
# this dataset was constructed from raw data using the script in R/datamaker.R
uvx_time_points <- read_rds("data/uvx_timepoints.rds") %>%
  # only keep weekdays
  filter(wday(time) %in% c(2:5)) %>%
  # only keep timepoints between 7 AM and 8 PM.
  filter(hour(time) >= 7, hour(time) <= 20) %>%
  # get rid of east bay stops
  filter(!timepoint %in% c("EASTBAYN", "EASTBAYS", "PROVFRST - 1", "PROVFRST - 2", "TOWNCNTR - 1", "TOWNCNTR - 2", "PROVFRST"))
```


```{r times, eval = FALSE}
# determine when the experiment switched values
uvx_time_points %>%
  arrange(time) %>%
  mutate(
    tchange = ifelse(threshold == lead(threshold), FALSE, TRUE),
    tperiod = cumsum(tchange)
  ) %>%
  group_by(tperiod, threshold) %>%
  summarise(start = min(date), end = max(date), n = n()) %>%
  arrange(start) %>%
  filter(n > 1)
```

UTA provided GPS timepoint data for all trips on the UVX system for the entirety
of 2019. We calculated the headway between successive UVX trips at each stop.
Because the UVX route loops around south Provo and stops at the Provo
FrontRunner station twice, this created some minor difficulties in data
processing, and we removed the timepoints on this portion of the route. We also
limit our analysis to the period between 7 AM and 8 PM.

From January through June 6, the system operated with a 5-minute TSP threshold,.
with TSP granted only if the vehicle was five or more minutes behind its scheduled
timepoint. After August 12, the system switched to a 2-minute TSP threshold. During the
summer, the TSP system was configured as follows for this experiment: 
  - May 2 through June 6, 2019: 5 minute threshold
  - June 10 through July 12 and after August 12: 2 minute threshold
  - July 15 through July 26: no TSP
  - July 30 through August 9: TSP always activated
We discarded trips from January through April and September through December
because the additional university passenger demand could interfere in the experiment.

To evaluate the effect of changing TSP threshold on headway adherence, we consider 